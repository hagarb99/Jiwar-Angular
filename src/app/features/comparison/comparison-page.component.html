<app-navbar></app-navbar>

<div class="comparison-wrapper">
    <!-- Header -->
    <div class="header-section">
        <h2>Property Comparison</h2>
        <div class="actions">
            <select [(ngModel)]="selectedUserType" class="user-type-select">
                <option [value]="0">Investor Perspective</option>
                <option [value]="1">Family Perspective</option>
                <option [value]="2">Budget Buyer Perspective</option>
            </select>

            <button class="analyze-btn" (click)="analyze()" [disabled]="comparisonIds.length < 2 || isLoadingAi">
                <lucide-angular *ngIf="!isLoadingAi" [img]="Brain" class="w-5 h-5"></lucide-angular>
                <span *ngIf="!isLoadingAi">Analyze with AI</span>
                <span *ngIf="isLoadingAi">Analyzing insights...</span>
            </button>
        </div>
    </div>

    <!-- Main Comparison Table Area -->
    <div class="table-container" *ngIf="properties.length > 0">
        <table class="comparison-table">
            <thead>
                <tr>
                    <th class="sticky-col">Feature</th>
                    <th *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="best-badge" *ngIf="aiResult?.bestPropertyId === property.propertyID">
                            <lucide-angular [img]="Star" class="w-3 h-3 inline-block -mt-1 mr-1"></lucide-angular>
                            Best Choice
                        </div>
                        <div class="property-header">
                            <img [src]="property.thumbnailUrl || '/assets/placeholder-property.jpg'"
                                class="property-img" alt="Property" (error)="onImageError($event)">
                            <span class="property-title text-center">{{ property.title }}</span>
                            <button class="remove-btn" (click)="removeProperty(property.propertyID)">
                                <lucide-angular [img]="X" class="w-4 h-4"></lucide-angular>
                            </button>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                <!-- Price -->
                <tr>
                    <td class="sticky-col">Price</td>
                    <td *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="cell-content">
                            <span class="price-val">{{ formatPrice(property.price) }}</span>
                        </div>
                    </td>
                </tr>
                <!-- Location -->
                <tr>
                    <td class="sticky-col">Location</td>
                    <td *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="cell-content">
                            <div class="flex items-center gap-1 loc-val">
                                <lucide-angular [img]="MapPin" class="w-4 h-4"></lucide-angular>
                                <span>{{ property.city }}{{ property.address ? ', ' + property.address : '' }}</span>
                            </div>
                        </div>
                    </td>
                </tr>
                <!-- Area -->
                <tr>
                    <td class="sticky-col">Area</td>
                    <td *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="cell-content">
                            <div class="feature-val">
                                <lucide-angular [img]="Maximize" class="w-4 h-4"></lucide-angular>
                                <span>{{ property.area_sqm || 'N/A' }} sqm</span>
                            </div>
                        </div>
                    </td>
                </tr>
                <!-- Bedrooms -->
                <tr>
                    <td class="sticky-col">Bedrooms</td>
                    <td *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="cell-content">
                            <div class="feature-val">
                                <lucide-angular [img]="Bed" class="w-4 h-4"></lucide-angular>
                                <span>{{ property.numBedrooms || 'N/A' }} Beds</span>
                            </div>
                        </div>
                    </td>
                </tr>
                <!-- Bathrooms -->
                <tr>
                    <td class="sticky-col">Bathrooms</td>
                    <td *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="cell-content">
                            <div class="feature-val">
                                <lucide-angular [img]="Bath" class="w-4 h-4"></lucide-angular>
                                <span>{{ property.numBathrooms || 'N/A' }} Baths</span>
                            </div>
                        </div>
                    </td>
                </tr>
                <!-- Property Type -->
                <tr>
                    <td class="sticky-col">Type</td>
                    <td *ngFor="let property of properties" class="prop-col"
                        [class.best-choice]="aiResult?.bestPropertyId === property.propertyID">
                        <div class="cell-content">
                            <span class="text-sm font-semibold uppercase tracking-wider text-slate-500">{{
                                property.propertyType }}</span>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Empty State -->
    <div class="empty-state-container" *ngIf="properties.length === 0">
        <div class="empty-icon">
            <lucide-angular [img]="Maximize" class="w-20 h-20 opacity-20"></lucide-angular>
        </div>
        <h3>No properties to compare</h3>
        <p>Add at least two properties from the search results to start comparing them.</p>
    </div>

    <!-- AI Results Section -->
    <div class="ai-analysis-container" *ngIf="aiResult">
        <!-- AI Summary Card -->
        <div class="ai-summary-card">
            <div class="ai-header-flex">
                <div class="ai-icon-bg">
                    <lucide-angular [img]="Sparkles" class="w-8 h-8"></lucide-angular>
                </div>
                <div>
                    <h3>Expert AI Consensus</h3>
                    <p>{{ aiResult.summary }}</p>
                </div>
            </div>
        </div>

        <!-- AI Scores Grid -->
        <div class="ai-properties-grid">
            <div *ngFor="let score of aiResult.scores" class="property-score-card"
                [class.best-choice]="score.propertyId === aiResult.bestPropertyId">

                <div class="score-top">
                    <div class="flex items-center gap-4">
                        <img [src]="getPropertyById(score.propertyId)?.thumbnailUrl || '/assets/placeholder.jpg'"
                            class="w-16 h-16 rounded-xl object-cover shadow-sm border border-slate-100"
                            (error)="onImageError($event)">
                        <div class="score-meta">
                            <h4>{{ getPropertyById(score.propertyId)?.title || 'Property #' + score.propertyId }}</h4>
                            <p>{{ getPropertyById(score.propertyId)?.city }}</p>
                        </div>
                    </div>

                    <!-- Circular Progress -->
                    <div class="circular-score">
                        <svg viewBox="0 0 36 36" class="circular-chart">
                            <path class="circle-bg"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="circle" [attr.stroke-dasharray]="score.totalScore + ', 100'"
                                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <text x="18" y="20.35" class="percentage">{{ score.totalScore }}%</text>
                        </svg>
                    </div>
                </div>

                <div class="overall-reason-box">
                    <p>{{ score.overallReason }}</p>
                </div>

                <!-- Category Breakdown -->
                <div class="category-scores">
                    <div *ngFor="let cat of score.categoryScores | keyvalue" class="category-item">
                        <div class="cat-header">
                            <span class="cat-name">{{ formatCategory(cat.key) }}</span>
                            <span class="cat-score">{{ cat.value.score }}%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-fill" [style.width.%]="cat.value.score"></div>
                        </div>
                        <p class="cat-desc">{{ cat.value.description }}</p>
                    </div>
                </div>

                <div *ngIf="score.propertyId === aiResult.bestPropertyId"
                    class="mt-6 flex items-center justify-center gap-2 py-3 px-4 bg-amber-50 rounded-xl border border-amber-200 text-amber-900 font-bold">
                    <lucide-angular [img]="Award" class="w-5 h-5"></lucide-angular>
                    <span>Recommended Match</span>
                </div>
            </div>
        </div>
    </div>
</div>

<app-footer></app-footer>